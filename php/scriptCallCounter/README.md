# Script Call Counter

Задание: Реализовать счетчик вызова скрипта. Было принято решение, хранить данные в файле.

```
<?php 

file_put_contents("./counter.txt", file_get_contents("./counter.txt") + 1);
```

Вопрос: Какие проблемы имеет данные подход? Как вы их можете решить? 
(Нельзя использовать другие технологии)

Дополнительный вопрос: Через некоторое время нагрузка на сервер значительно выросла. Какие проблемы вы видите? Как вы их можете решить? 
Если бы вы могли выбрать другую технологию, то какую и почему?

# Solve

1 .	Если при первом вызове файл counter.txt не существует, получаем warning. Можно добавить такой код

```
if(!file_exists("./counter.txt")){
    file_put_contents("./counter.txt", 0);
}
```

2 .	Проблема с tread safe. Если сделать, например, такой скрипт и запустить одновременно в 2х консолях, то в итоге получаем неправильный результат. У меня получилось 231. И постоянно сыпались ошибки. Должно быть 2000. 

```
for($i=0; $i<1000; $i++){
    echo $i . "\n";
    file_put_contents("./counter.txt", file_get_contents("./counter.txt") + 1);
}
```

Можно решить с помощью flock. Создать отдельный файл, lock.txt.
Его блокировать и проверять. Примерно так. Чтобы проверить более наглядно, можно добавить задержку во время блокировки.

```
$filename = "./counter.txt";
$lock = "./lock.txt";
$handle = fopen($lock, 'r+');
while (!flock($handle,  LOCK_EX)) {
    echo "usleep\n";
    usleep(1);
}
file_put_contents($filename, file_get_contents($filename) + 1);
//sleep(5);
flock($handle, LOCK_UN);
fclose($handle);
```

3 . Дополнительный вопрос

Могут возникнуть проблемы со скоростью записи. Много запросов одновременно, поэтому файл почти постоянно заблокирован. В итоге задержка все увеличивается для новых запросов. Если нужно использовать файлы, можно попробовать такой подход: Каждый запрос создает свой файл с уникальным именем. В фоновом режиме будет работать скрипт,  который считает количество файлов и удаляет. Количество уже записывает куда-нибудь. Здесь нет проблемы конкурентного доступа к файлу. Но есть проблема большого количества мелких файлов. Не уверен, в эффективности, но попробовать можно.

# Demo

Run test.php in 2 consoles in the same time.
See counter.txt for results

```
php test.php
```